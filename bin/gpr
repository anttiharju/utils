#!/usr/bin/env dash
set -eu

# Git PR:
# open the existing or a new PR for current branch. On default branch opens the repo.

# Determine default branch.
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
	default_branch=$(git rev-parse --abbrev-ref origin/HEAD)
	default_branch=${default_branch#"origin/"}
else
	echo "Error: gpr must be run in a Git repository."
	exit 1
fi

# Get origin URL and ensure it's in GitHub.
origin=$(git remote get-url origin)
case "$origin" in
	*github.com*)
		;;
	*)
		echo "Error: gpr requires origin url in GitHub."
		exit 1
		;;
esac

# Extract the repository URL in a format that can be opened in a browser.
if echo "$origin" | grep -q 'git@github.com:'; then
	repo_url="https://github.com/$(echo "$origin" | sed 's/^.*github.com://;s/.git$//')"
elif echo "$origin" | grep -q 'https://github.com/'; then
	repo_url=$(echo "$origin" | sed 's/.git$//')
else
	echo "Error: gpr only supports ssh and https-cloned repos."
	exit 1
fi

# Get current branch name.
branch=$(git rev-parse --abbrev-ref HEAD)

# Open the repo on default branch.
if [ "$branch" = "$default_branch" ]; then
	open "$repo_url"
	exit $?
fi

# Open the URL that either directs to the existing PR or to the wizard to open a new one.
pr_url="$repo_url/pull/new/$branch"
open "$pr_url"
